<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Command Center</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">

        <header class="animate-entry">
            <h1>Water Quality <span>Analytics</span></h1>
            <div class="subtitle">Deep Dive into Historical Data & Performance Metrics</div>

            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 2rem;">
                <div class="nav-container" style="margin-top: 0;">
                    <a href="/" class="nav-pill">Dashboard</a>
                    <a href="/analytics" class="nav-pill active">Analytics</a>
                </div>
            </div>
        </header>

        <div class="dashboard-grid animate-entry animate-delay-1" style="grid-template-columns: 1fr;">

            <!-- Key Metrics Row -->
            <div class="row">
                <div class="col card glass">
                    <p class="text-muted"
                        style="margin: 0; font-size: 0.8rem; font-weight: 700; text-transform: uppercase;">Total Samples
                        Processed</p>
                    <div id="totalSamples"
                        style="font-size: 3.5rem; font-weight: 800; color: var(--text-primary); margin: 0.5rem 0;">...
                    </div>
                    <span class="status-pill status-safe">+12.5% vs last month</span>
                </div>
                <div class="col card glass">
                    <p class="text-muted"
                        style="margin: 0; font-size: 0.8rem; font-weight: 700; text-transform: uppercase;">Active
                        Districts</p>
                    <div id="districtCount"
                        style="font-size: 3.5rem; font-weight: 800; color: var(--primary); margin: 0.5rem 0;">...</div>
                    <span class="text-muted" style="font-size: 0.9rem;">100% Coverage</span>
                </div>
                <div class="col card glass">
                    <p class="text-muted"
                        style="margin: 0; font-size: 0.8rem; font-weight: 700; text-transform: uppercase;">State Risk
                        Index</p>
                    <div id="avgChlorophyll"
                        style="font-size: 3.5rem; font-weight: 800; color: var(--accent); margin: 0.5rem 0;">...</div>
                    <span class="text-muted" style="font-size: 0.9rem;">Avg Chlorophyll (ug/L)</span>
                </div>
            </div>

            <!-- Middle Row: Gauge & Distribution -->
            <div class="row animate-entry animate-delay-2">
                <div class="col card glass" style="flex: 1;">
                    <h3>State Health Gauge</h3>
                    <div style="height: 250px; position: relative;">
                        <canvas id="gaugeChart"></canvas>
                        <div
                            style="position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div id="gaugeValue" style="font-size: 2rem; font-weight: 800; color: var(--text-primary);">
                                ...</div>
                            <div
                                style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 600;">
                                Overall Score</div>
                        </div>
                    </div>
                </div>
                <div class="col card glass" style="flex: 2;">
                    <h3>Risk Distribution</h3>
                    <div style="height: 250px;">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Head-to-Head Comparator -->
            <div class="card glass animate-entry animate-delay-3" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 0.5rem;">Head-to-Head Comparator</h3>
                <p class="text-muted">Directly compare district profiles to identify relative risks.</p>

                <div style="display: flex; gap: 2rem; margin-top: 1.5rem;">
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 1.5rem;">
                        <div
                            style="background: #f8fafc; padding: 1.5rem; border-radius: 16px; border-left: 4px solid #3b82f6;">
                            <select id="districtA" class="glass-input" style="margin-bottom: 1rem;"></select>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <div class="text-muted" style="font-size: 0.75rem;">AVG RISK</div><strong
                                        id="statA_avg" style="font-size: 1.2rem;">-</strong>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.75rem;">VOLATILITY</div><strong
                                        id="statA_vol" style="font-size: 1.2rem;">-</strong>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.75rem;">PEAK</div><strong
                                        id="statA_peak" style="font-size: 1.2rem;">-</strong>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.75rem;">CLIMATE</div><strong
                                        id="statA_cli" style="font-size: 1.2rem;">-</strong>
                                </div>
                            </div>
                        </div>

                        <div
                            style="background: #f8fafc; padding: 1.5rem; border-radius: 16px; border-left: 4px solid #ef4444;">
                            <select id="districtB" class="glass-input" style="margin-bottom: 1rem;"></select>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <div class="text-muted" style="font-size: 0.75rem;">AVG RISK</div><strong
                                        id="statB_avg" style="font-size: 1.2rem;">-</strong>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.75rem;">VOLATILITY</div><strong
                                        id="statB_vol" style="font-size: 1.2rem;">-</strong>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.75rem;">PEAK</div><strong
                                        id="statB_peak" style="font-size: 1.2rem;">-</strong>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.75rem;">CLIMATE</div><strong
                                        id="statB_cli" style="font-size: 1.2rem;">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="flex: 2; height: 400px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Correlation Lab Row -->
            <div class="card glass animate-entry animate-delay-3" style="min-height: 400px; margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: top; margin-bottom: 2rem;">
                    <div>
                        <h3>Correlation Discovery Lab</h3>
                        <p class="text-muted" style="margin: 0; font-size: 0.9rem;">Verify the science. See how
                            environmental factors impact water quality.</p>
                    </div>
                    <select id="xaxisSelect" class="glass-input"
                        style="width: auto; height: fit-content; font-size: 0.9rem; padding: 0.5rem 1.5rem;">
                        <option value="Precipitation_mm">X-Axis: Precipitation (Rainfall)</option>
                        <option value="Temperature_C">X-Axis: Temperature</option>
                    </select>
                </div>
                <div style="height: 350px; width: 100%;">
                    <canvas id="correlationChart"></canvas>
                </div>
            </div>

            <!-- Leaderboard Table -->
            <div class="card glass animate-entry animate-delay-3"
                style="padding: 0; overflow: hidden; margin-top: 2rem;">
                <div style="padding: 2rem 2rem 1rem 2rem;">
                    <h3>District Leaderboard</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th style="padding-left: 2rem;">District</th>
                                <th>Avg Chlorophyll</th>
                                <th>Volatility (σ)</th>
                                <th>Peak Level</th>
                                <th>Risk Status</th>
                                <th style="padding-right: 2rem;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let rawData = [];
            let districtData = {};
            let radarChart = null;

            try {
                const res = await fetch('/api/analytics');
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                rawData = data.raw_data;
                data.leaderboard.forEach(d => districtData[d.district] = d);

                document.getElementById('totalSamples').innerText = data.total_samples.toLocaleString();
                document.getElementById('districtCount').innerText = data.district_count;
                document.getElementById('avgChlorophyll').innerText = data.avg_chlorophyll;
                document.getElementById('gaugeValue').innerText = data.avg_chlorophyll;

                new Chart(document.getElementById('gaugeChart'), {
                    type: 'doughnut',
                    data: { labels: ['Level', 'Remaining'], datasets: [{ data: [data.avg_chlorophyll, 20 - data.avg_chlorophyll], backgroundColor: [data.avg_chlorophyll > 10 ? '#ef4444' : (data.avg_chlorophyll > 5 ? '#f59e0b' : '#10b981'), '#f3f4f6'], borderWidth: 0, cutout: '80%', circumference: 180, rotation: 270, borderRadius: 10 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                let counts = { Safe: 0, Warning: 0, Critical: 0 }; data.leaderboard.forEach(d => counts[d.status]++);
                new Chart(document.getElementById('distributionChart'), {
                    type: 'bar',
                    data: { labels: ['Safe', 'Warning', 'Critical'], datasets: [{ label: 'Districts', data: [counts.Safe, counts.Warning, counts.Critical], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderRadius: 8, barThickness: 40 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
                });

                initCorrelationChart();

                const districts = Object.keys(districtData).sort();
                const selA = document.getElementById('districtA');
                const selB = document.getElementById('districtB');
                districts.forEach(d => { selA.add(new Option(d, d)); selB.add(new Option(d, d)); });
                if (districts.length > 1) { selA.value = districts[0]; selB.value = districts[1]; }

                function updateComparator() {
                    const dA = districtData[selA.value];
                    const dB = districtData[selB.value];
                    document.getElementById('statA_avg').innerText = dA.avg;
                    document.getElementById('statA_vol').innerText = dA.volatility;
                    document.getElementById('statA_peak').innerText = dA.peak;
                    document.getElementById('statA_cli').innerText = `${dA.avg_precip}mm / ${dA.avg_temp}°C`;
                    document.getElementById('statB_avg').innerText = dB.avg;
                    document.getElementById('statB_vol').innerText = dB.volatility;
                    document.getElementById('statB_peak').innerText = dB.peak;
                    document.getElementById('statB_cli').innerText = `${dB.avg_precip}mm / ${dB.avg_temp}°C`;

                    const norm = (val, max) => Math.min((val / max) * 10, 10);
                    const dataA = [norm(dA.avg, 15), norm(dA.volatility, 5), norm(dA.peak, 20), norm(dA.avg_precip, 5), norm(dA.avg_temp, 35)];
                    const dataB = [norm(dB.avg, 15), norm(dB.volatility, 5), norm(dB.peak, 20), norm(dB.avg_precip, 5), norm(dB.avg_temp, 35)];

                    if (radarChart) radarChart.destroy();
                    radarChart = new Chart(document.getElementById('radarChart'), {
                        type: 'radar',
                        data: {
                            labels: ['Avg Risk', 'Volatility', 'Peak Severity', 'Rainfall', 'Temperature'],
                            datasets: [{ label: dA.district, data: dataA, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)', borderWidth: 3 }, { label: dB.district, data: dataB, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', borderWidth: 3 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, max: 10, ticks: { display: false } } } }
                    });
                }

                selA.addEventListener('change', updateComparator);
                selB.addEventListener('change', updateComparator);
                updateComparator();

                document.getElementById('leaderboardBody').innerHTML = data.leaderboard.map(d => {
                    const statusClass = d.status === 'Critical' ? 'status-critical' : (d.status === 'Warning' ? 'status-warning' : 'status-safe');
                    return `<tr><td style="padding-left: 2rem; font-weight: 600;">${d.district}</td><td>${d.avg}</td><td>${d.volatility}</td><td>${d.peak}</td><td><span class="status-pill ${statusClass}">${d.status}</span></td><td style="padding-right: 2rem;"><a href="/?district=${d.district}" style="text-decoration: none; color: var(--primary); font-weight: 600;">Analyze &rarr;</a></td></tr>`;
                }).join('');

            } catch (err) { console.error(err); }

            function initCorrelationChart() {
                const ctx = document.getElementById('correlationChart').getContext('2d');
                const xAxisKey = document.getElementById('xaxisSelect').value;
                const scatterData = rawData.map(d => ({ x: d[xAxisKey], y: d.Chlorophyll_ug_L }));
                new Chart(ctx, {
                    type: 'scatter',
                    data: { datasets: [{ label: `${xAxisKey} vs Chlorophyll`, data: scatterData, backgroundColor: 'rgba(59, 130, 246, 0.6)' }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { color: '#f3f4f6' } }, y: { grid: { color: '#f3f4f6' } } } }
                });
            }
            document.getElementById('xaxisSelect').addEventListener('change', initCorrelationChart);

        });
    </script>
</body>

</html>